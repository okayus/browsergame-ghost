# Implementation Plan

## Task Overview

ゴーストRPGゲームの実装タスク。まずpnpmモノレポ構成とCI/CDパイプラインを整備し、その後基盤となるデータ定義、ゲームロジック、UI、統合の順に進行する。

---

## Branch & PR Rules

各サブタスク（1.1, 1.2, ...）ごとにブランチを作成し、完了時にPull Requestを作成する。

### ブランチ命名規則

```
feat/task-{メジャータスク番号}.{サブタスク番号}-{簡潔な説明}
```

**例:**
- `feat/task-1.1-pnpm-workspace`
- `feat/task-1.2-github-actions-ci`
- `feat/task-2.1-tailwind-setup`

### ワークフロー

1. **ブランチ作成**: `git checkout -b feat/task-X.Y-description`
2. **実装**: タスクの内容を実装
3. **コミット**: 変更をコミット
4. **プッシュ**: `git push -u origin feat/task-X.Y-description`
5. **PR作成**: `gh pr create` でPull Requestを作成
6. **マージ**: レビュー後、mainブランチにマージ

### PR テンプレート

```markdown
## Summary
- タスク X.Y: {タスクタイトル}
- {実装内容の簡潔な説明}

## Test plan
- [ ] CI passes (lint, typecheck, test)
- [ ] {タスク固有の確認項目}
```

---

## Tasks

- [x] 1. モノレポ・CI/CD基盤セットアップ
- [x] 1.1 (P) pnpmワークスペースを構成する
  - pnpm-workspace.yamlの作成・確認
  - packages/backend, packages/frontendの依存関係整理
  - 共通設定（TypeScript、Biome）のルート配置
  - ワークスペース間の依存関係設定
  - _Requirements: 10.1_

- [x] 1.2 (P) GitHub Actions CIパイプラインを構築する
  - .github/workflows/ci.ymlの拡張
  - pnpm installとキャッシュ設定
  - lint、typecheck、testジョブの追加
  - backend/frontend両パッケージの並列実行
  - _Requirements: 10.1_

- [x] 1.3 (P) Cloudflareデプロイパイプラインを構築する
  - Cloudflare Pages（Frontend）デプロイ設定
  - Cloudflare Workers（Backend）デプロイ設定
  - 環境変数・シークレット設定
  - ブランチ戦略（main→本番、PR→プレビュー）
  - _Requirements: 10.1_

- [ ] 2. フロントエンド基盤セットアップ
- [ ] 2.1 (P) Tailwind CSSをフロントエンドに導入する
  - Tailwind CSSのインストールと設定ファイル作成
  - Vite設定にTailwindプラグインを追加
  - ゲーム用のカスタムカラーパレットを定義
  - 既存のApp.tsxをTailwindスタイルに変換して動作確認
  - _Requirements: 10.1_

- [ ] 2.2 (P) Clerk認証をセットアップする
  - @clerk/clerk-reactをフロントエンドにインストール
  - ClerkProviderでアプリをラップ
  - サインイン/サインアップボタンを配置
  - @hono/clerk-authをバックエンドにインストール
  - 認証ミドルウェアを作成
  - _Requirements: 10.1_

- [ ] 3. ゲームデータスキーマ定義
- [ ] 3.1 (P) ゴーストと技のZodスキーマを定義する
  - ゴーストタイプ（炎、水、草、電気、霊、ノーマル）のスキーマ
  - 能力値（HP、攻撃、防御、素早さ）のスキーマ
  - 技（名前、タイプ、威力、命中率、PP）のスキーマ
  - ゴースト種族マスタ（基礎能力値、習得技リスト）のスキーマ
  - プレイヤー所持ゴースト（レベル、経験値、現在HP、技4つ）のスキーマ
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1_

- [ ] 3.2 (P) アイテムとインベントリのZodスキーマを定義する
  - アイテム種別（回復系、捕獲系、その他）のスキーマ
  - アイテム（名前、種別、効果量）のスキーマ
  - インベントリ（アイテムIDと所持数のマップ）のスキーマ
  - _Requirements: 7.1, 7.2_

- [ ] 3.3 (P) パーティとプレイヤーのZodスキーマを定義する
  - パーティ（最大6体のゴースト配列）のスキーマ
  - プレイヤー位置のスキーマ
  - マップタイル（タイプ、移動可否、エンカウント率）のスキーマ
  - _Requirements: 6.1, 1.4_

- [ ] 4. マスタデータ作成
- [ ] 4.1 (P) ゴースト種族マスタデータを作成する
  - 最低6種類のゴースト（各タイプ1体以上）を定義
  - 各ゴーストの基礎能力値を設定
  - レベルごとの習得技リストを設定
  - _Requirements: 2.1, 2.2, 2.4_

- [ ] 4.2 (P) 技マスタデータを作成する
  - 各タイプの技を複数定義
  - 威力、命中率、PPを設定
  - _Requirements: 2.4, 3.1_

- [ ] 4.3 (P) タイプ相性表を作成する
  - 6タイプ間の相性倍率（2倍、0.5倍、0倍、1倍）を定義
  - 相性表データ構造を作成
  - _Requirements: 3.2_

- [ ] 4.4 (P) アイテムマスタデータを作成する
  - 回復アイテム（ポーション等）を定義
  - 捕獲アイテム（ゴーストボール等）を定義
  - _Requirements: 7.1_

- [ ] 4.5 (P) 初期マップデータを作成する
  - グリッドベースのマップタイル配列を定義
  - 草むら（エンカウント可能エリア）を配置
  - 壁・障害物（移動不可）を配置
  - _Requirements: 1.2, 1.3, 1.4_

- [ ] 5. ゲームロジック実装（バトル）
- [ ] 5.1 ダメージ計算ロジックを実装する
  - 攻撃側の攻撃力、防御側の防御力からダメージを計算
  - タイプ相性倍率を適用
  - クリティカルヒット判定を実装
  - _Requirements: 3.3, 3.4, 3.5, 3.6, 4.5_

- [ ] 5.2 ターン順序決定ロジックを実装する
  - 両者の素早さを比較
  - 先攻・後攻を決定
  - _Requirements: 4.4_

- [ ] 5.3 逃走成功率計算ロジックを実装する
  - 自分と相手の素早さ比較で成功率を決定
  - 乱数判定で成功/失敗を返す
  - _Requirements: 9.1, 9.2_

- [ ] 5.4 捕獲成功率計算ロジックを実装する
  - 対象ゴーストのHP残量から基本成功率を計算
  - 捕獲アイテムのボーナスを加算
  - 乱数判定で成功/失敗を返す
  - _Requirements: 5.2, 5.3_

- [ ] 6. ゲームロジック実装（育成）
- [ ] 6.1 経験値計算ロジックを実装する
  - 倒した野生ゴーストのレベルから獲得経験値を計算
  - _Requirements: 8.1, 8.2_

- [ ] 6.2 レベルアップ判定ロジックを実装する
  - 現在経験値と次レベル必要経験値を比較
  - レベルアップ時の能力値再計算
  - 習得可能技のチェック
  - _Requirements: 2.3, 2.5, 8.3, 8.4, 8.5_

- [ ] 7. 状態管理フック実装
- [ ] 7.1 ゲーム全体の状態管理フックを実装する
  - 現在画面（マップ/バトル/パーティ/メニュー）の状態
  - 画面切り替えアクション
  - パーティとインベントリの状態保持
  - _Requirements: 10.1_

- [ ] 7.2 マップ状態管理フックを実装する
  - 現在マップIDとプレイヤー位置の状態
  - 移動アクション（方向を受け取り位置を更新）
  - 移動可否判定（壁チェック）
  - エンカウント判定（草むらでの乱数チェック）
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 7.3 バトル状態管理フックを実装する
  - バトルフェーズ（コマンド選択、技選択、実行中、結果）の状態
  - プレイヤーゴーストと敵ゴーストの状態
  - コマンド選択アクション
  - ターン実行アクション（ダメージ計算ロジック呼び出し）
  - バトル終了判定（HP0、逃走、捕獲）
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8_

- [ ] 7.4 インベントリ状態管理フックを実装する
  - 所持アイテム一覧の状態
  - アイテム使用アクション（所持数減少）
  - アイテム追加アクション
  - _Requirements: 7.2, 7.5, 7.6_

- [ ] 8. UIコンポーネント実装（共通）
- [ ] 8.1 ゲームコンテナコンポーネントを実装する
  - 画面状態に応じたコンポーネント切り替え
  - キーボードイベントリスナーの設定
  - ゲーム全体のレイアウト
  - _Requirements: 10.1, 10.4_

- [ ] 8.2 メッセージボックスコンポーネントを実装する
  - バトルメッセージの表示
  - メッセージキューの順次表示
  - _Requirements: 10.3_

- [ ] 9. UIコンポーネント実装（マップ）
- [ ] 9.1 マップグリッドコンポーネントを実装する
  - CSS Gridでタイル配列を描画
  - タイルタイプに応じた表示（草、地面、壁、水）
  - _Requirements: 1.4_

- [ ] 9.2 マップ画面コンポーネントを実装する
  - マップグリッドとプレイヤーキャラクターの表示
  - WASDキー入力による移動処理
  - プレイヤー位置の視覚的識別
  - エンカウント発生時のバトル画面遷移
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 10. UIコンポーネント実装（バトル）
- [ ] 10.1 バトル画面コンポーネントを実装する
  - 味方ゴーストと敵ゴーストの表示
  - HP、名前、レベルの表示
  - バトルフェーズに応じたパネル切り替え
  - _Requirements: 4.1, 10.2_

- [ ] 10.2 コマンドパネルコンポーネントを実装する
  - たたかう、アイテム、逃げる、捕まえるの4コマンド表示
  - キーボードでの選択操作
  - 選択時のアクション発火
  - _Requirements: 4.2, 10.4_

- [ ] 10.3 技選択パネルコンポーネントを実装する
  - 使用可能な技一覧の表示
  - 技タイプと残りPPの表示
  - 技選択時のアクション発火
  - _Requirements: 4.3_

- [ ] 10.4 アイテム選択パネルコンポーネントを実装する
  - 使用可能なアイテム一覧の表示
  - 所持数の表示
  - 所持数0のアイテムは使用不可表示
  - _Requirements: 7.3, 7.6_

- [ ] 11. UIコンポーネント実装（パーティ・捕獲）
- [ ] 11.1 パーティ画面コンポーネントを実装する
  - パーティ内ゴースト一覧の表示
  - 各ゴーストのステータス（HP、レベル、タイプ）表示
  - ゴーストの順番変更機能
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 11.2 ゴースト交代パネルコンポーネントを実装する
  - バトル中の交代可能ゴースト一覧
  - 戦闘不能ゴーストは選択不可
  - 交代時のアクション発火
  - _Requirements: 6.4, 6.5_

- [ ] 11.3 捕獲アイテム選択パネルコンポーネントを実装する
  - 捕獲系アイテムのみ表示
  - 使用時の捕獲判定呼び出し
  - _Requirements: 5.1_

- [ ] 11.4 捕獲成功時の処理コンポーネントを実装する
  - パーティ上限チェック
  - 上限時はボックス送りか入れ替えかの選択肢表示
  - パーティへの追加処理
  - _Requirements: 5.4, 5.6_

- [ ] 12. バトル終了処理実装
- [ ] 12.1 勝利時の処理を実装する
  - 経験値計算と付与
  - レベルアップ判定と通知
  - 技習得処理（上限4つの入れ替え選択含む）
  - マップ画面への遷移
  - _Requirements: 4.7, 8.1, 8.3, 8.4, 8.5, 8.6_

- [ ] 12.2 敗北時の処理を実装する
  - 敗北メッセージ表示
  - ゲーム継続のための処理（HP回復、初期位置戻り等）
  - _Requirements: 4.8_

- [ ] 12.3 逃走処理を実装する
  - 逃走成功時のマップ画面遷移
  - 逃走失敗時のターン消費
  - _Requirements: 9.3, 9.4_

- [ ] 12.4 捕獲失敗時の処理を実装する
  - アイテム消費
  - バトル継続（敵のターン）
  - _Requirements: 5.5_

- [ ] 13. バックエンドAPI実装
- [ ] 13.1 データベーススキーマを定義する
  - players, player_ghosts, player_itemsテーブル作成
  - Drizzle ORMスキーマ定義
  - マイグレーション生成
  - _Requirements: 6.1, 7.2_

- [ ] 13.2 セーブデータAPIを実装する
  - Clerk認証ミドルウェア適用
  - セーブデータ取得エンドポイント（GET /api/save）
  - セーブデータ保存エンドポイント（POST /api/save）
  - Zodバリデーション適用
  - _Requirements: 10.1_

- [ ] 14. フロントエンド・バックエンド統合
- [ ] 14.1 Hono RPCクライアントをセットアップする
  - バックエンドからAppType型をエクスポート
  - フロントエンドでhcクライアントを設定
  - 認証トークンの自動付与設定
  - _Requirements: 10.1_

- [ ] 14.2 セーブ/ロード機能を統合する
  - ゲーム開始時のセーブデータ読み込み
  - 定期的な自動セーブ
  - 手動セーブ機能
  - _Requirements: 10.1_

- [ ] 15. 画面遷移とトランジション
- [ ] 15.1 画面遷移トランジションを実装する
  - マップ→バトル遷移エフェクト
  - バトル→マップ遷移エフェクト
  - メニュー画面の表示アニメーション
  - _Requirements: 10.5_

- [ ] 16. テスト実装
- [ ] 16.1 (P) ゲームロジックのユニットテストを実装する
  - ダメージ計算テスト（タイプ相性各パターン）
  - 捕獲率計算テスト（HP残量パターン）
  - 経験値・レベルアップ計算テスト
  - _Requirements: 3.3, 3.4, 3.5, 3.6, 5.2, 5.3, 8.1, 8.2, 8.3_

- [ ] 16.2 (P) 状態管理フックのテストを実装する
  - マップ移動テスト（壁判定、エンカウント）
  - バトル進行テスト（コマンド→実行→結果）
  - インベントリ操作テスト
  - _Requirements: 1.1, 1.2, 1.3, 4.4, 4.5, 7.5_

- [ ] 16.3* UIコンポーネントのレンダリングテストを実装する
  - マップ画面の描画テスト
  - バトル画面のコマンド表示テスト
  - パーティ画面のゴースト一覧テスト
  - _Requirements: 1.4, 1.5, 4.1, 4.2, 6.2_

- [ ] 17. プレイヤー登録・認証フロー実装
- [x] 17.1 新規プレイヤー初期化APIを実装する
  - Clerk認証済みユーザー向けの初期化エンドポイント作成
  - 初期ゴースト（レベル5）をパーティに追加するロジック
  - 初期アイテム（ゴーストボール×5、ポーション×3）の付与
  - 初期マップと開始位置の設定
  - 既存プレイヤーが呼び出した場合は409エラーを返す
  - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 17.2 認証状態管理フックを実装する
  - Clerk認証状態の監視と画面状態の決定
  - 認証成功時のセーブデータ読み込みトリガー
  - セーブデータ不在時の新規プレイヤー初期化呼び出し
  - エラー時のリトライ機能
  - ローディング状態の管理
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6_

- [ ] 17.3 (P) ローディング画面コンポーネントを実装する
  - セーブデータ読み込み中のローディングアニメーション表示
  - 読み込み状態のテキスト表示
  - Tailwind CSSアニメーションユーティリティの活用
  - _Requirements: 12.5_

- [ ] 17.4 アプリのルートコンポーネントを認証フローに対応させる
  - 未認証時はウェルカム画面（サインイン/サインアップボタン）を表示
  - 認証済み＆データ読み込み中はローディング画面を表示
  - 認証済み＆データ読み込み完了後はゲームメイン画面（マップ画面）を表示
  - エラー発生時はエラー画面とリトライボタンを表示
  - GameContainerとの統合
  - _Requirements: 12.1, 12.4_

- [ ] 17.5 セーブデータ永続化機能を強化する
  - ゲーム状態変更時の自動セーブ（既存useSaveDataの活用）
  - バックエンド通信失敗時のローカルキャッシュ保存
  - 復旧後の自動同期処理
  - 最終更新日時の記録と表示
  - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1-1.5 | 3.3, 4.5, 7.2, 9.1, 9.2, 16.2, 16.3 |
| 2.1-2.5 | 3.1, 4.1, 6.2 |
| 3.1-3.6 | 3.1, 4.2, 4.3, 5.1, 16.1 |
| 4.1-4.8 | 5.1, 5.2, 7.3, 10.1, 10.2, 10.3, 12.1, 12.2, 16.2 |
| 5.1-5.6 | 5.4, 11.3, 11.4, 12.4, 16.1 |
| 6.1-6.5 | 3.3, 11.1, 11.2, 13.1, 16.3 |
| 7.1-7.6 | 3.2, 4.4, 7.4, 10.4, 16.2 |
| 8.1-8.6 | 6.1, 6.2, 12.1, 16.1 |
| 9.1-9.4 | 5.3, 12.3 |
| 10.1-10.5 | 1.1, 1.2, 1.3, 2.1, 2.2, 7.1, 8.1, 8.2, 13.2, 14.1, 14.2, 15.1, 16.3 |
| 11.1-11.5 | 17.1 |
| 12.1-12.6 | 17.2, 17.3, 17.4 |
| 13.1-13.5 | 17.5 |
