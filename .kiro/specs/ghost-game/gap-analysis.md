# ギャップ分析レポート

## 概要

本分析は、要件15-17（バトル後HP同期、バトル中アイテム使用、手動セーブ）と既存コードベースとのギャップを調査したものです。

---

## 1. 現状調査

### 1.1 関連アセットマップ

| ファイル | 役割 | 行数 |
|----------|------|------|
| `App.tsx` | メインコントローラー、画面遷移、バトルハンドラー | ~470 |
| `useBattleState.ts` | バトル状態管理、アクション実行 | ~465 |
| `useGameState.ts` | ゲーム全体状態、パーティ管理 | ~172 |
| `useInventoryState.ts` | インベントリ管理、アイテム使用 | ~181 |
| `useSaveData.ts` | TanStack Query、自動セーブ | ~316 |
| `ItemSelectPanel.tsx` | アイテム選択UI | ~191 |
| `BattleScreen.tsx` | バトル画面レイアウト | ~80 |

### 1.2 既存パターン・規約

```
データフロー:
┌─────────────┐     ┌──────────────┐     ┌───────────────┐
│ useGameState │ ──> │ useBattleState │ ──> │ BattleScreen  │
│ (party, inv) │     │ (playerGhost)  │     │ (UI表示)      │
└─────────────┘     └──────────────┘     └───────────────┘
       │                                          │
       └──────────── useAutoSave ────────────────┘
                   (30秒ごと自動保存)
```

**重要な規約**:
- バトル状態はゲーム状態とは分離されている（`BattleGhostState`は`OwnedGhost`のコピー）
- UIフックは`useCallback`でメモ化
- 状態更新は不変性を維持（spread operator）
- テストは`*.test.ts(x)`に配置

### 1.3 統合ポイント

| 統合ポイント | 現在の状態 | 要件への影響 |
|-------------|-----------|-------------|
| `resetBattle()` | バトル状態のみクリア、パーティHP未更新 | 要件15で拡張必要 |
| `handleBattleCommand("item")` | `// 将来実装`コメントのみ | 要件16で実装必要 |
| `handleMenuSelect("save")` | `console.log`のみ | 要件17で実装必要 |
| `updatePartyGhost()` | 実装済みだが未使用 | 要件15で活用 |
| `useSaveDataMutation()` | 実装済みだが手動呼び出しなし | 要件17で活用 |

---

## 2. 要件実現可能性分析

### 2.1 要件15: バトル終了後のパーティHP同期

| 技術要素 | 現状 | ギャップ |
|----------|------|---------|
| パーティHP更新API | ✅ `updatePartyGhost()` 実装済み | なし |
| バトル終了検知 | ✅ `result.battleEnded` で判定可 | なし |
| HP取得 | ✅ `battleState.playerGhost.currentHp` | なし |
| セーブキュー追加 | ✅ `updatePendingSaveData()` 実装済み | なし |
| 敗北時全回復 | ❌ ロジック未実装 | **Missing** |

**複雑度**: CRUD + 単純ロジック
**制約**: バトル終了後の`resetBattle()`呼び出し前にHP同期が必要

### 2.2 要件16: バトル中アイテム使用

| 技術要素 | 現状 | ギャップ |
|----------|------|---------|
| アイテム選択UI | ✅ `ItemSelectPanel.tsx` 実装済み | なし |
| アイテム消費API | ✅ `useItem()` 実装済み | なし |
| フェーズ管理 | ✅ `setPhase("item_select")` 対応済み | なし |
| 回復アイテム効果適用 | ❌ 未実装 | **Missing** |
| 捕獲ボーナス計算 | ⚠️ `itemBonus`パラメータはあるがUI未接続 | **Constraint** |
| カテゴリ別UI分岐 | ❌ 回復/捕獲の分岐ロジック未実装 | **Missing** |

**複雑度**: ワークフロー（複数画面遷移）
**制約**: `BattlePhase`型に既に`"item_select"`が含まれている

### 2.3 要件17: 手動セーブ機能

| 技術要素 | 現状 | ギャップ |
|----------|------|---------|
| セーブMutation | ✅ `useSaveDataMutation()` 実装済み | なし |
| メニューハンドラー | ✅ `handleMenuSelect("save")` 存在 | stub実装のみ |
| セーブ状態表示 | ✅ `SaveStatus`コンポーネント存在 | 拡張が必要 |
| 成功/失敗フィードバック | ❌ 未実装 | **Missing** |

**複雑度**: 単純CRUD
**制約**: 既存の自動セーブと競合しないよう注意

---

## 3. 実装アプローチオプション

### オプションA: 既存コンポーネント拡張

**対象**: 全要件

| 変更ファイル | 変更内容 | 影響度 |
|-------------|---------|--------|
| `App.tsx` | バトル終了ハンドラー拡張、アイテムコマンド接続、セーブハンドラー実装 | 高 |
| `useBattleState.ts` | アイテム使用アクション追加（オプション） | 中 |

**トレードオフ**:
- ✅ 新規ファイル不要
- ✅ 既存パターン活用
- ❌ `App.tsx`が肥大化（現在~470行→推定~550行）
- ❌ 責務の混在リスク

### オプションB: 新規コンポーネント作成

**対象**: 要件16のアイテム使用ロジック

| 新規ファイル | 役割 |
|-------------|------|
| `useBattleItemAction.ts` | バトル中アイテム使用ロジック |
| `BattleItemFlow.tsx` | アイテム選択→効果適用のフロー管理 |

**トレードオフ**:
- ✅ 責務分離が明確
- ✅ テスト容易
- ❌ ファイル数増加
- ❌ 既存フローとの統合が複雑

### オプションC: ハイブリッドアプローチ（推奨）

**戦略**:
1. **要件15, 17**: オプションA（`App.tsx`拡張）
2. **要件16**: 新規フック`useBattleItem.ts`を作成し、`App.tsx`から呼び出し

**段階的実装**:
1. Phase 1: 要件17（手動セーブ）- 最小工数
2. Phase 2: 要件15（HP同期）- バトルフロー理解後
3. Phase 3: 要件16（アイテム使用）- 最も複雑

**トレードオフ**:
- ✅ 段階的リスク軽減
- ✅ 複雑なロジック（アイテム使用）のみ分離
- ✅ 単純な機能は素早く実装
- ❌ 若干の設計判断が必要

---

## 4. 工数・リスク評価

| 要件 | 工数 | リスク | 根拠 |
|------|------|--------|------|
| 15: HP同期 | **S (1-2日)** | **Low** | 既存API活用、ロジック単純、影響範囲限定 |
| 16: アイテム使用 | **M (3-5日)** | **Medium** | UIは既存、ロジック追加、複数フロー分岐 |
| 17: 手動セーブ | **S (0.5-1日)** | **Low** | 既存Mutation活用、UI変更最小 |

**合計見積もり**: **M (4-8日)**

---

## 5. 設計フェーズへの推奨事項

### 推奨アプローチ
**オプションC（ハイブリッド）** を推奨

### 実装順序
1. 要件17: 手動セーブ（最小工数でクイックウィン）
2. 要件15: HP同期（バトルフローの理解を深める）
3. 要件16: アイテム使用（最も複雑、前2つの知見を活用）

### リサーチ項目（設計フェーズで解決）
- [ ] 回復アイテム使用時のターン消費タイミング（敵の行動前 or 後）
- [ ] 捕獲アイテムのボーナス計算式の詳細
- [ ] 敗北時のHP全回復タイミング（即座 or アニメーション後）

### 重要な設計決定
1. **アイテムカテゴリ分岐**: `ItemSelectPanel`を直接使うか、カテゴリ選択画面を追加するか
2. **HP同期タイミング**: バトル結果表示前 or 後
3. **セーブフィードバック**: トースト通知 vs インライン表示

---

_分析日: 2026-01-11_
_対象要件: 15, 16, 17_
